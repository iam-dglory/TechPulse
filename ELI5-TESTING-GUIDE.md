# ELI5 Toggle System - End-to-End Testing Guide

This guide provides comprehensive testing instructions for the ELI5 (Explain Like I'm 5) system with OpenAI integration, community suggestions, and reviewer UI.

## 🎯 **System Overview**

The ELI5 system provides:

- **Dual Explanations**: Simple (ELI5) and technical versions of stories
- **OpenAI Integration**: AI-powered explanation generation with caching
- **Community Suggestions**: Users can suggest better explanations
- **Reviewer UI**: Admin interface for approving/rejecting suggestions
- **Mobile Toggle**: Seamless switching between simple and technical modes

## 📋 **Prerequisites**

### Backend Setup

```bash
# 1. Install dependencies
cd backend
npm install

# 2. Run database migrations
npm run typeorm:migrate

# 3. Set OpenAI API key (optional but recommended)
export OPENAI_API_KEY="your-openai-api-key"

# 4. Start the backend server
npm run dev:ts:watch

# 5. Seed the database (optional)
npm run seed
```

### Mobile App Setup

```bash
# 1. Install dependencies
cd TexhPulzeMobile
npm install

# 2. Start the mobile app
npm start
```

### OpenAI Setup (Optional)

```bash
# Set OpenAI API key in environment
export OPENAI_API_KEY="sk-your-openai-api-key"

# Or add to .env file
echo "OPENAI_API_KEY=sk-your-openai-api-key" >> backend/.env
```

## 🧪 **Test Scenarios**

### **Scenario 1: Generate ELI5 Explanations (Backend)**

#### Step 1: Test ELI5 Generation with OpenAI

```bash
# Get a story ID first
STORY_ID="existing-story-id"

# Generate both simple and technical explanations
curl -X POST "http://localhost:5000/api/stories/$STORY_ID/eli5" \
  -H "Content-Type: application/json" \
  -d '{"mode": "both"}'
```

**Expected Result:**

```json
{
  "success": true,
  "message": "ELI5 explanations generated successfully",
  "data": {
    "storyId": "story-id",
    "mode": "both",
    "simpleSummary": "This story is about... [AI-generated simple explanation]",
    "technicalSummary": "This development represents... [AI-generated technical explanation]",
    "explanation": "Generated by OpenAI GPT-4"
  }
}
```

#### Step 2: Test Cached Retrieval

```bash
# Get cached explanations
curl -X GET "http://localhost:5000/api/stories/$STORY_ID/eli5?mode=both"
```

**Expected Result:**

```json
{
  "success": true,
  "message": "ELI5 explanations retrieved successfully",
  "data": {
    "storyId": "story-id",
    "mode": "both",
    "simpleSummary": "Cached simple explanation...",
    "technicalSummary": "Cached technical explanation...",
    "hasCached": true,
    "hasSimple": true,
    "hasTechnical": true
  }
}
```

#### Step 3: Test Individual Mode Generation

```bash
# Generate only simple explanation
curl -X POST "http://localhost:5000/api/stories/$STORY_ID/eli5" \
  -H "Content-Type: application/json" \
  -d '{"mode": "simple"}'

# Generate only technical explanation
curl -X POST "http://localhost:5000/api/stories/$STORY_ID/eli5" \
  -H "Content-Type: application/json" \
  -d '{"mode": "technical"}'
```

### **Scenario 2: Community Suggestions System**

#### Step 1: Create ELI5 Suggestion

```bash
# Create a suggestion for better explanation
curl -X POST "http://localhost:5000/api/eli5-suggestions" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "storyId": "story-id",
    "mode": "simple",
    "suggestedText": "This is a much clearer explanation that uses everyday language and analogies to help regular people understand the complex technology story.",
    "explanation": "My explanation is better because it uses analogies and avoids technical jargon."
  }'
```

**Expected Result:**

```json
{
  "success": true,
  "message": "ELI5 suggestion created successfully",
  "data": {
    "suggestion": {
      "id": "suggestion-id",
      "storyId": "story-id",
      "mode": "simple",
      "suggestedText": "This is a much clearer explanation...",
      "explanation": "My explanation is better because...",
      "status": "pending",
      "upvotes": 0,
      "downvotes": 0,
      "createdAt": "2024-01-15T10:30:00.000Z"
    }
  }
}
```

#### Step 2: Vote on Suggestion

```bash
SUGGESTION_ID="suggestion-id"

# Upvote the suggestion
curl -X POST "http://localhost:5000/api/eli5-suggestions/$SUGGESTION_ID/vote" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"voteType": "upvote"}'

# Downvote the suggestion
curl -X POST "http://localhost:5000/api/eli5-suggestions/$SUGGESTION_ID/vote" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"voteType": "downvote"}'
```

#### Step 3: Admin Review and Approval

```bash
# Approve the suggestion (admin only)
curl -X PUT "http://localhost:5000/api/eli5-suggestions/$SUGGESTION_ID" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "approved",
    "reviewNotes": "Great explanation! Much clearer than the original."
  }'
```

**Expected Result:**

```json
{
  "success": true,
  "message": "ELI5 suggestion approved successfully",
  "data": {
    "suggestionId": "suggestion-id",
    "status": "approved",
    "reviewedAt": "2024-01-15T11:00:00.000Z",
    "storyUpdated": true
  }
}
```

### **Scenario 3: Mobile App ELI5 Interface**

#### Step 1: Navigate to Story View

1. Open mobile app
2. Navigate to any story
3. Look for the ELI5 section with toggle button

#### Step 2: Test ELI5 Toggle

1. Tap "Show Explanation" button
2. Verify explanation appears
3. Test toggle between Simple/Technical modes
4. Verify different content for each mode

#### Step 3: Test Suggestion Modal

1. Tap "Suggest Better Explanation" button
2. Verify modal opens with current text pre-filled
3. Enter a better explanation
4. Add optional explanation for why it's better
5. Submit the suggestion
6. Verify success message and modal closes

#### Step 4: Test Mode Switching

1. Toggle between Simple and Technical modes
2. Verify content changes appropriately
3. Test suggestion button works for both modes
4. Verify current text is pre-filled correctly

### **Scenario 4: Admin Review Interface**

#### Step 1: Access Review Panel

1. Navigate to ELI5 Review screen (admin only)
2. Verify pending suggestions are listed
3. Test filter buttons (Pending, Approved, Rejected, All)

#### Step 2: Review Suggestion

1. Tap on a pending suggestion
2. Read the suggested text and explanation
3. Check vote counts and community feedback
4. Tap "Approve" or "Reject" button
5. Verify confirmation dialog appears
6. Confirm action and verify status changes

#### Step 3: Test Filtering

1. Filter by "Pending" - should show only pending suggestions
2. Filter by "Approved" - should show only approved suggestions
3. Filter by "All" - should show all suggestions
4. Verify counts update correctly

### **Scenario 5: Fallback Without OpenAI**

#### Step 1: Test Without OpenAI API Key

```bash
# Remove OpenAI API key
unset OPENAI_API_KEY

# Generate ELI5 explanations
curl -X POST "http://localhost:5000/api/stories/$STORY_ID/eli5" \
  -H "Content-Type: application/json" \
  -d '{"mode": "both"}'
```

**Expected Result:**

```json
{
  "success": true,
  "message": "ELI5 explanations generated successfully",
  "data": {
    "storyId": "story-id",
    "mode": "both",
    "simpleSummary": "This story is about [basic template explanation]...",
    "technicalSummary": "This development represents [basic template explanation]...",
    "explanation": "Generated using basic template (OpenAI not available)"
  }
}
```

## 🔧 **Advanced Testing**

### **Test Database Schema**

#### Verify New Fields

```sql
-- Check ELI5 fields in stories table
SELECT
  id,
  title,
  eli5_summary,
  simple_summary,
  technical_summary,
  created_at
FROM stories
WHERE simple_summary IS NOT NULL OR technical_summary IS NOT NULL
LIMIT 5;

-- Check ELI5 suggestions table
SELECT
  id,
  story_id,
  mode,
  status,
  upvotes,
  downvotes,
  created_at
FROM eli5_suggestions
ORDER BY created_at DESC
LIMIT 5;
```

#### Test Relationships

```sql
-- Check suggestions with story details
SELECT
  s.id as suggestion_id,
  s.mode,
  s.status,
  s.upvotes,
  s.downvotes,
  st.title as story_title,
  u.username as suggested_by
FROM eli5_suggestions s
JOIN stories st ON s.story_id = st.id
JOIN users u ON s.user_id = u.id
ORDER BY s.created_at DESC;
```

### **Test API Edge Cases**

#### Invalid Story ID

```bash
curl -X POST "http://localhost:5000/api/stories/invalid-id/eli5" \
  -H "Content-Type: application/json" \
  -d '{"mode": "simple"}'
```

#### Invalid Mode

```bash
curl -X POST "http://localhost:5000/api/stories/$STORY_ID/eli5" \
  -H "Content-Type: application/json" \
  -d '{"mode": "invalid"}'
```

#### Duplicate Suggestions

```bash
# Try to create duplicate suggestion
curl -X POST "http://localhost:5000/api/eli5-suggestions" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "storyId": "story-id",
    "mode": "simple",
    "suggestedText": "Another suggestion for the same story and mode"
  }'
```

### **Test Mobile App Edge Cases**

#### No Explanations Available

1. Navigate to a story without ELI5 explanations
2. Tap "Show Explanation"
3. Verify "No explanation available" message appears
4. Test suggestion button still works

#### Network Errors

1. Disconnect from internet
2. Try to generate ELI5 explanations
3. Try to submit suggestions
4. Verify appropriate error messages

#### Long Text Handling

1. Create a story with very long content
2. Generate ELI5 explanations
3. Verify explanations are appropriately truncated
4. Test mobile display handles long text correctly

## 📊 **Expected Database State**

### Stories Table with ELI5 Fields

```sql
SELECT
  id,
  title,
  simple_summary IS NOT NULL as has_simple,
  technical_summary IS NOT NULL as has_technical,
  eli5_summary IS NOT NULL as has_eli5
FROM stories
WHERE simple_summary IS NOT NULL OR technical_summary IS NOT NULL;
```

### ELI5 Suggestions Statistics

```sql
SELECT
  status,
  mode,
  COUNT(*) as count,
  AVG(upvotes) as avg_upvotes,
  AVG(downvotes) as avg_downvotes
FROM eli5_suggestions
GROUP BY status, mode
ORDER BY status, mode;
```

## ✅ **Success Criteria**

### Backend API:

- [ ] ELI5 explanations generate successfully with OpenAI
- [ ] Fallback works when OpenAI is not available
- [ ] Explanations are cached in database
- [ ] Community suggestions can be created and voted on
- [ ] Admin can approve/reject suggestions
- [ ] Approved suggestions update story explanations
- [ ] All validation and error handling works correctly

### Mobile App:

- [ ] ELI5 toggle shows/hides explanations correctly
- [ ] Simple/Technical mode switching works
- [ ] Suggestion modal opens and submits correctly
- [ ] Current text is pre-filled in suggestion modal
- [ ] Error handling works for network issues
- [ ] UI handles long text appropriately

### Admin Interface:

- [ ] Review panel shows pending suggestions
- [ ] Filtering works for all status types
- [ ] Approve/Reject actions work correctly
- [ ] Approved suggestions update stories
- [ ] Review notes are saved and displayed

### Data Integrity:

- [ ] Foreign key relationships work correctly
- [ ] Suggestions link to correct stories and users
- [ ] Vote counts are accurate
- [ ] Status changes are tracked with timestamps
- [ ] Story updates reflect approved suggestions

## 🐛 **Common Issues & Troubleshooting**

### Issue: "OpenAI API key not found"

**Solution:** Set `OPENAI_API_KEY` environment variable or use fallback mode

### Issue: "Story not found" when generating ELI5

**Solution:** Verify story ID exists in database

### Issue: "Duplicate suggestion" error

**Solution:** User can only have one pending suggestion per story/mode combination

### Issue: Mobile app not showing explanations

**Solution:** Check if story has cached explanations or generate them first

### Issue: Suggestion modal not opening

**Solution:** Verify user is authenticated and story ID is valid

### Issue: Admin cannot approve suggestions

**Solution:** Ensure user has admin privileges (`isActive: true`)

## 🚀 **Production Deployment Notes**

### OpenAI Integration:

- Set up proper API key management
- Implement rate limiting for OpenAI calls
- Monitor API usage and costs
- Set up fallback mechanisms for API failures

### Database:

- Add indexes for performance on large datasets
- Consider archiving old suggestions
- Regular cleanup of rejected suggestions

### Caching Strategy:

- Implement Redis caching for frequently accessed explanations
- Cache OpenAI responses to reduce API calls
- Set appropriate cache expiration times

### Community Moderation:

- Set up automated spam detection
- Implement suggestion quality scoring
- Consider user reputation systems
- Set up moderation workflows

## 📝 **Test Results Template**

```
Test Date: ___________
Tester: ___________

Backend API:
- [ ] ELI5 generation with OpenAI
- [ ] ELI5 generation fallback
- [ ] Cached retrieval
- [ ] Community suggestions
- [ ] Voting system
- [ ] Admin approval/rejection

Mobile App:
- [ ] ELI5 toggle functionality
- [ ] Mode switching (Simple/Technical)
- [ ] Suggestion modal
- [ ] Text pre-filling
- [ ] Error handling

Admin Interface:
- [ ] Review panel access
- [ ] Suggestion filtering
- [ ] Approve/Reject actions
- [ ] Review notes
- [ ] Story updates

Database:
- [ ] ELI5 fields in stories
- [ ] Suggestions table
- [ ] Relationships integrity
- [ ] Vote tracking

Notes:
_________________________________
_________________________________
```

This testing guide ensures the complete ELI5 system works end-to-end from AI generation through community suggestions to admin review! 🎉🤖✨

